# supervisor-32： 32位监控程序

## 移植介绍

使用如下命令下载supervisor的源码

```
git clone https://github.com/z4yx/supervisor-mips32.git
```

###### 修改/kernel/kern/init.S 文件

在111行起始处，将原来控制串口可读中断部分代码注释，加入适配MNaive MIPS的关中断程序，之后再加入等待同步的程序。

###### 修改/kernel/kern/kernel.lh文件

将 SerialData 的地址改为 0xBFD03000，SerialStat的地址改为0xBFD03014

###### 修改/kernel/kern/utils.S文件

在15行起始处，修改 截取写状态位 地址为 0x0020

在37行起始处，修改 截取读状态 

## 使用介绍

监控程序，能够接受用户命令，支持输入汇编指令并运行，查看寄存器及内存状态等功能。监控程序可在学生实现的 32 位 MIPS CPU 上运行，一方面可以帮助学生理解、掌握 MIPS 指令系统及其软件开发，另一方面可以作为验证学生 CPU 功能正确性的标准。

监控程序分为两个部分，Kernel 和 Term。其中 Kernel 使用 MIPS32 汇编语言编写，运行在 Thinpad 上学生实现的 CPU 中，用于管理硬件资源；Term 是上位机程序，使用 Python 语言编写，有基于命令行的用户界面，达到与用户交互的目的。Kernel 和 Term 直接通过串口通信，即用户在 Term 界面中输入的命令、代码经过 Term 处理后，通过串口传输给 Kernel 程序；反过来，Kernel 输出的信息也会通过串口传输到 Term，并展示给用户。

## Kernel

Kernel 使用汇编语言编写，使用到的指令有20余条，均符合 MIPS32 Release2 规范。Kernel 提供了三种不同的版本，以适应不同的档次的 CPU 实现。它们分别是：第一档为基础版本，直接基本的I/O和命令执行功能，不依赖异常、中断、CP0等处理器特征，适合于最简单的 CPU 实现；第二档支持中断，使用中断方式完成串口的I/O功能，需要处理器实现中断处理机制，及相关的CP0处理器；第三档在第二档基础上进一步增加了TLB的应用，要求处理器支持基于TLB的内存映射，更加接近于操作系统对处理器的需求。

为了在硬件上运行 Kernel 程序，我们首先要对 Kernel 的汇编代码进行编译。在\`kernel\`文件夹下面，有汇编代码和 Makefile 文件，我们可以使用 make 工具编译 Kernel 程序。假设当前目录为 \`kernel\` ，目标版本为基础版本，我们在终端中运行命令

```
make ON_FPGA=y
```

即可开始编译流程。

监控程序还附带了几个测试程序，代码见\`kern/test.S\`。我们可以通过命令

```
make show-utest
```

来查看测试程序入口地址。记下这些地址，并在 Term 中使用G命令运行它们。

串口控制器访问的代码位于\`kern/utils.S\`，其数据格式为：

当收到启动用户程序的命令后，用户线程代替 shell 线程的活动。用户程序的寄存器，保存在从 0x807F0000 到 0x807F0077 的连续120字节中，依次对应 $1 到 $30 用户寄存器，每次启动用户程序时从上述地址装载寄存器值，用户程序运行结束后保存到上述地址。

## 进阶一：中断和异常支持

作为扩展功能之一，Kernel 支持中断方式的I/O，和 Syscall 功能。要启用这一功能，编译时的命令变为：

```
make ON_FPGA=y EN_INT=y
```

这一编译选项，会使得代码编译时增加宏定义\`ENABLE\_INT\`，从而使能中断相关的代码。

## 进阶二：TLB支持

在支持异常处理的基础上，可以进一步使能TLB支持，从而实现用户态地址映射。要启用这一功能，编译时的命令变为：

```
make ON_FPGA=y EN_INT=y EN_TLB=y
```

## Term

Term 程序运行在实验者的电脑上，提供监控程序和人交互的界面。Term 支持7种命令，它们分别是

* R：按照$1至$30的顺序返回用户程序寄存器值。

* D：显示从指定地址开始的一段内存区域中的数据。

* A：用户输入汇编指令，并放置到指定地址上

* U：从指定地址读取一定长度的数据，并显示反汇编结果。

* G：执行指定地址的用户程序。

* T：查看指定的TLB条目。本功能仅在Kernel支持TLB时有效。

* Q：退出 Term

利用这些命令，实验者可以输入一段汇编程序，检查数据是否正确写入，并让程序在处理器上运行验证。

Term 程序位于\`term\`文件夹中，可执行文件为\`term.py\`。运行程序时用 -s 选项指定串口。例如：

```
./term.py -s /dev/ttyUSB0（串口名称根据实际情况修改）
```

连接远程实验平台，或者 QEMU 模拟器时，使用 -t 选项指定 IP 和端口。例如：

```
./term.py -s 127.0.0.1:6666
```

## 用户程序编写

根据监控程序设计，用户程序的代码区为0x80100000-0x803FFFFF，实验时需要把用户程序写入这一区域。

用户程序的最后需要以`jr $31`结束，从而保证正确返回监控程序。

在输入用户程序的过程中，既可以用汇编指令，也可以直接写16进制的机器码。空行表示输入结束。

以下是一次输入用户程序并运行的过程演示：

```
MONITOR for MIPS32 - initialized.
>> A 
>>addr: 0x80100000 
one instruction per line, empty line to end. 
[0x80100000] addiu $2,$0,1 
[0x80100004] addu $3,$2,$2 
[0x80100008] jr $31 
[0x8010000c] nop 
[0x80100010] 
>> U 
>>addr: 0x80100000 
>>num: 16 
0x80100000: li v0,1 
0x80100004: addu v1,v0,v0 
0x80100008: jr ra 
0x8010000c: nop 
>> G 
>>addr: 0x80100000 

elapsed time: 0.000s 
>> R 
R1 (AT) = 0x00000000 
R2 (v0) = 0x00000001 
R3 (v1) = 0x00000002 
R4 (a0) = 0x00000000 
R5 (a1) = 0x00000000 
R6 (a2) = 0x00000000 
...
```



